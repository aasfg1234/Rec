<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµé€ï¼šæ•¸æ“šç›£æ§ä¸­å¿ƒ (v2.1 Sortable)</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #252525;
            --text-main: #e0e0e0;
            --text-muted: #888;
            --accent: #ffb74d; 
            --valid: #66bb6a;
            --invalid: #ef5350;
            --border: #333;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'JetBrains Mono', monospace;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        .container {
            width: 100%; max-width: 900px;
            background: var(--panel-bg);
            padding: 30px; border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        /* Debug Logger */
        #debug-panel {
            width: 100%; max-width: 900px;
            background: #000; color: #0f0;
            padding: 20px; border-radius: 8px;
            font-size: 12px; font-family: monospace;
            border: 1px solid #333;
            height: 150px; overflow-y: scroll;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }

        header {
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 1px solid var(--border); padding-bottom: 20px; margin-bottom: 20px;
        }
        h1 { margin: 0; font-size: 24px; color: var(--accent); font-family: 'Noto Serif TC', serif; letter-spacing: 2px; }
        .stats { font-size: 13px; color: var(--text-muted); text-align: right; }
        .stats span { color: #fff; font-weight: bold; margin-left: 5px; }

        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;}
        button {
            padding: 8px 16px; border: 1px solid var(--border); background: #333;
            color: #fff; cursor: pointer; border-radius: 4px; font-family: inherit;
            transition: 0.2s; font-size: 13px;
        }
        button:hover { background: #444; border-color: #666; }
        button.primary { background: var(--accent); border-color: var(--accent); color: #1a1a1a; font-weight: bold; }
        
        /* Sort Buttons Active State */
        button.active { background: #555; border-color: #fff; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 12px; border-bottom: 2px solid var(--border); color: var(--text-muted); font-weight: normal; cursor: pointer;}
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        tr:hover { background: rgba(255,255,255,0.02); }

        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .valid { background-color: var(--valid); box-shadow: 0 0 5px var(--valid); }
        .invalid { background-color: var(--invalid); box-shadow: 0 0 5px var(--invalid); }
        .row-invalid { color: var(--invalid); opacity: 0.7; text-decoration: line-through; }
    </style>
</head>
<body>

<div id="debug-panel">Waiting for action...</div>

<div class="container">
    <header>
        <div>
            <h1>æµé€ï¼šè³‡æ–™åº«è¦–åœ–</h1>
            <small style="color:#666">PANTRY CLOUD / RAW DATA VIEWER</small>
        </div>
        <div class="stats">
            <div>å…¨çƒéŠç©ç¸½æ¬¡æ•¸ <span id="globalCount">--</span></div>
            <div>ç¸½ç´€éŒ„ç­†æ•¸ <span id="recordCount">--</span></div>
        </div>
    </header>

    <div class="toolbar">
        <button onclick="loadData()" class="primary">â†» é‡æ–°æ•´ç†</button>
        <span style="border-left: 1px solid #444; margin: 0 10px;"></span>
        <button onclick="changeSort('score')" id="btnSortScore" class="active">ğŸ† æŒ‰æ’å (é«˜â†’ä½)</button>
        <button onclick="changeSort('date')" id="btnSortDate">ğŸ“… æŒ‰æ™‚é–“ (æ–°â†’èˆŠ)</button>
        
        <span style="flex:1"></span>
        <button onclick="exportCSV()">â¬‡ åŒ¯å‡º CSV</button>
    </div>

    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th width="60">#</th>
                    <th width="100">ç‹€æ…‹</th>
                    <th>ç©å®¶åç¨±</th>
                    <th>å­˜æ´»æ™‚é–“ (ç§’)</th>
                    <th>ç´€éŒ„æ™‚é–“</th>
                    <th width="120" style="font-family: monospace; font-size: 12px; color: #555;">Hash Check</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                </tbody>
        </table>
        <div id="loading" style="text-align:center; padding:20px; color:#888; display:none;">è®€å–ä¸­...</div>
    </div>
</div>

<script>
    const PANTRY_ID = "3b037575-e357-4684-9646-47f5b3ff2ee7"; 
    const BASKET_NAME = "Rank_v1"; 
    const PROXY_BASE = "https://corsproxy.io/?";
    const TARGET_URL = `https://getpantry.cloud/apiv1/pantry/${PANTRY_ID}/basket/${BASKET_NAME}`;
    const SECRET_SALT = "TheFlow_Survival_2025_HellMode_Secured";

    let rawScores = []; // åŸå§‹è³‡æ–™
    let currentSortMode = 'score'; // ç•¶å‰æ’åºæ¨¡å¼: 'score' | 'date'

    function log(msg) {
        const panel = document.getElementById('debug-panel');
        const time = new Date().toLocaleTimeString();
        panel.innerHTML = `[${time}] ${msg}\n` + panel.innerHTML;
        console.log(`[Debug] ${msg}`);
    }

    function generateSignature(name, score) {
        const scoreStr = parseFloat(score).toFixed(2);
        const raw = name + "_" + scoreStr + "_" + SECRET_SALT;
        let hash = 0;
        for (let i = 0; i < raw.length; i++) {
            const char = raw.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return hash.toString(16);
    }

    function loadData() {
        const tbody = document.getElementById('tableBody');
        const loading = document.getElementById('loading');
        
        tbody.innerHTML = '';
        loading.style.display = 'block';
        log("é–‹å§‹é€£ç·š...");

        const bustedUrl = PROXY_BASE + encodeURIComponent(TARGET_URL + `?_t=${Date.now()}`);

        fetch(bustedUrl)
            .then(res => {
                if (!res.ok) throw new Error(`HTTP Error ${res.status}`);
                return res.json();
            })
            .then(data => {
                loading.style.display = 'none';
                processData(data);
            })
            .catch(err => {
                loading.style.display = 'none';
                log("éŒ¯èª¤: " + err.message);
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: #ef5350; padding: 30px;">è®€å–å¤±æ•—: ${err.message}</td></tr>`;
            });
    }

    function processData(data) {
        let scores = [];
        let globalCount = 0;

        if (Array.isArray(data)) {
            scores = data;
            globalCount = "N/A";
        } else if (typeof data === 'object' && data !== null) {
            scores = data.scores || [];
            globalCount = data.global_play_count || 0;
        }

        document.getElementById('globalCount').innerText = globalCount;
        document.getElementById('recordCount').innerText = scores.length;
        
        rawScores = scores; // å­˜å…¥å…¨åŸŸè®Šæ•¸
        log(`å–å¾— ${scores.length} ç­†è³‡æ–™`);
        
        renderTable(); // æ¸²æŸ“è¡¨æ ¼
    }

    // === åˆ‡æ›æ’åº ===
    function changeSort(mode) {
        currentSortMode = mode;
        
        // æ›´æ–°æŒ‰éˆ•æ¨£å¼
        document.getElementById('btnSortScore').className = mode === 'score' ? 'active' : '';
        document.getElementById('btnSortDate').className = mode === 'date' ? 'active' : '';
        
        log(`åˆ‡æ›æ’åºæ¨¡å¼: ${mode}`);
        renderTable();
    }

    // === æ¸²æŸ“è¡¨æ ¼æ ¸å¿ƒé‚è¼¯ ===
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';

        // è¤‡è£½ä¸€ä»½è³‡æ–™ä¾†æ’åºï¼Œä»¥å…å‹•åˆ°åŸå§‹è³‡æ–™
        let displayData = [...rawScores];

        if (currentSortMode === 'score') {
            // åˆ†æ•¸ç”±é«˜åˆ°ä½
            displayData.sort((a, b) => parseFloat(b.score) - parseFloat(a.score));
        } else {
            // æ™‚é–“ç”±æ–°åˆ°èˆŠ (Date.now() è¶Šå¤§è¶Šæ–°)
            displayData.sort((a, b) => (b.date || 0) - (a.date || 0));
        }

        if (displayData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 30px;">ç„¡è³‡æ–™</td></tr>`;
            return;
        }

        displayData.forEach((entry, index) => {
            const expectedSig = generateSignature(entry.name, entry.score);
            const isValid = entry.signature && entry.signature === expectedSig;
            
            let dateStr = 'Unknown';
            if (entry.date) {
                const d = new Date(entry.date);
                // æ ¼å¼åŒ–ç‚º YYYY-MM-DD HH:MM:SS
                dateStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')} <span style="color:#aaa">${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}</span>`;
            }

            const tr = document.createElement('tr');
            if (!isValid) tr.className = 'row-invalid';

            // å¦‚æœæ˜¯æŒ‰æ™‚é–“æ’åºï¼Œå‰é¢çš„åºè™Ÿå°±åªæ˜¯è¡Œè™Ÿï¼Œä¸æ˜¯æ’å
            let rankDisplay = index + 1;
            let rankColor = currentSortMode === 'score' ? '#ffb74d' : '#888';

            tr.innerHTML = `
                <td><span style="color: ${rankColor}; font-weight:bold;">${rankDisplay}</span></td>
                <td>
                    <span class="status-dot ${isValid ? 'valid' : 'invalid'}"></span>
                    ${isValid ? 'OK' : 'ERR'}
                </td>
                <td style="font-weight:bold; color: #fff;">${sanitize(entry.name)}</td>
                <td style="font-family: 'JetBrains Mono'; font-size: 15px;">${parseFloat(entry.score).toFixed(4)} s</td>
                <td style="color: #ddd; font-size: 13px;">${dateStr}</td>
                <td style="font-family: monospace; font-size: 11px; color: #444;">
                    ${entry.signature ? entry.signature.substring(0, 6) : '---'}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function sanitize(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.innerText = str;
        return div.innerHTML;
    }

    function exportCSV() {
        if (!rawScores || rawScores.length === 0) { alert("ç„¡è³‡æ–™"); return; }
        let csv = "data:text/csv;charset=utf-8,\uFEFFRank,Name,Score,Date,Signature,Valid\n";
        
        // åŒ¯å‡ºæ™‚é è¨­ç”¨åˆ†æ•¸æ’åº
        let exportData = [...rawScores].sort((a, b) => b.score - a.score);

        exportData.forEach((entry, index) => {
            const dateStr = entry.date ? new Date(entry.date).toISOString() : '';
            const valid = (entry.signature === generateSignature(entry.name, entry.score)) ? 'TRUE' : 'FALSE';
            csv += `${index+1},"${entry.name.replace(/"/g, '""')}",${entry.score},${dateStr},${entry.signature},${valid}\n`;
        });
        
        const link = document.createElement("a");
        link.href = encodeURI(csv);
        link.download = `rank_export_${Date.now()}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // å•Ÿå‹•
    loadData();
</script>

</body>
</html>
